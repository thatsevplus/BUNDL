{% if section.settings.collection != blank %}
  {%- assign feat_collection = section.settings.collection -%}
  <section class="section-padding">
    <div class="gingr-container">
      <div class="flex flex-col sm:flex-row items-start sm:items-end justify-between gap-4 mb-10">
        <div>
          {% if section.settings.eyebrow != blank %}
            <p class="text-xs font-bold uppercase tracking-[0.2em] text-white/40 mb-2">{{ section.settings.eyebrow }}</p>
          {% endif %}
          <h2 class="text-2xl md:text-3xl font-bold text-white">{{ section.settings.heading | default: feat_collection.title }}</h2>
          {% if section.settings.subheading != blank %}
            <p class="text-sm text-white/40 mt-1">{{ section.settings.subheading }}</p>
          {% endif %}
        </div>
        <a href="{{ feat_collection.url }}" class="hidden sm:inline-flex items-center gap-2 text-sm font-semibold text-white/50 hover:text-white no-underline transition-colors border border-white/10 px-4 py-2 rounded-lg hover:border-white/20">
          View all
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3"/></svg>
        </a>
      </div>

      {%- comment -%} Bundle nudge banner {%- endcomment -%}
      {% if section.settings.bundle_nudge != blank %}
        <div class="mb-6 p-3 rounded-xl border border-gingr-yellow/20 bg-gingr-yellow/5 text-center">
          <p class="text-sm font-medium text-accent">{{ section.settings.bundle_nudge }}</p>
        </div>
      {% endif %}

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-{{ section.settings.columns | default: 4 }} gap-4 md:gap-5">
        {% for product in feat_collection.products limit: section.settings.limit %}
          <article class="product-card group relative">
            <a href="{{ product.url }}" class="block no-underline">
              {%- comment -%} Image {%- endcomment -%}
              <div class="aspect-square bg-white/5 overflow-hidden relative">
                {% if product.featured_image %}
                  {{ product.featured_image | image_url: width: 600 | image_tag:
                    class: 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-300',
                    loading: 'lazy',
                    widths: '300,400,600'
                  }}
                {% else %}
                  <div class="w-full h-full flex items-center justify-center text-white/10">
                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5A2.25 2.25 0 0 0 22.5 18.75V5.25A2.25 2.25 0 0 0 20.25 3H3.75A2.25 2.25 0 0 0 1.5 5.25v13.5A2.25 2.25 0 0 0 3.75 21Z"/></svg>
                  </div>
                {% endif %}

                {%- comment -%} Sale badge {%- endcomment -%}
                {% if product.compare_at_price > product.price %}
                  <span class="absolute top-2 left-2 text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full bg-red-500 text-white">Sale</span>
                {% endif %}
              </div>

              {%- comment -%} Info {%- endcomment -%}
              <div class="p-4">
                {%- comment -%} Dietary badges {%- endcomment -%}
                {% if product.metafields.health.dietary_badges.value %}
                  <div class="flex flex-wrap gap-1 mb-2">
                    {% for badge_text in product.metafields.health.dietary_badges.value %}
                      {% render 'badge', text: badge_text %}
                    {% endfor %}
                  </div>
                {% endif %}

                <h3 class="text-sm font-semibold text-white mb-1">{{ product.title }}</h3>

                {%- comment -%} Price with compare-at {%- endcomment -%}
                <div class="flex items-center gap-2">
                  {% if product.price_varies %}
                    <p class="text-sm font-bold text-accent">From {{ product.price_min | money }}</p>
                  {% else %}
                    <p class="text-sm font-bold text-accent">{{ product.price | money }}</p>
                  {% endif %}
                  {% if product.compare_at_price > product.price %}
                    <p class="text-xs text-white/30 line-through">{{ product.compare_at_price | money }}</p>
                  {% endif %}
                </div>

                {%- comment -%} Pack savings hint {%- endcomment -%}
                {% if product.variants.size > 1 %}
                  {% assign best_variant = product.variants | last %}
                  {% assign single_variant = product.variants | first %}
                  {% if best_variant.price < single_variant.price %}
                    {% assign pack_savings = single_variant.price | minus: best_variant.price | times: 100 | divided_by: single_variant.price %}
                    {% if pack_savings > 0 %}
                      <p class="text-xs text-white/30 mt-1">Save up to {{ pack_savings }}% with packs</p>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </a>

            {%- comment -%} Quick add button {%- endcomment -%}
            {% if product.available and product.variants.size == 1 %}
              <div class="px-4 pb-4">
                <form action="{{ routes.cart_add_url }}" method="post">
                  <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
                  <input type="hidden" name="quantity" value="1">
                  <button type="submit" class="w-full py-2 rounded-lg text-xs font-bold bg-white/10 text-white hover:bg-white/20 transition-all border border-white/10">
                    Quick add
                  </button>
                </form>
              </div>
            {% elsif product.available %}
              <div class="px-4 pb-4">
                <a href="{{ product.url }}" class="block w-full py-2 rounded-lg text-xs font-bold bg-white/10 text-white hover:bg-white/20 transition-all border border-white/10 text-center no-underline">
                  Choose option
                </a>
              </div>
            {% else %}
              <div class="px-4 pb-4">
                <span class="block w-full py-2 rounded-lg text-xs font-bold bg-white/5 text-white/20 text-center border border-white/5">Sold out</span>
              </div>
            {% endif %}
          </article>
        {% endfor %}
      </div>

      <div class="sm:hidden mt-6 text-center">
        <a href="{{ feat_collection.url }}" class="btn-outline text-sm">View all products</a>
      </div>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "Featured collection",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow text"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "bundle_nudge",
      "label": "Bundle nudge text (optional)",
      "default": "Buy 6+ shots and save 10% automatically"
    },
    {
      "type": "range",
      "id": "limit",
      "min": 4,
      "max": 12,
      "step": 1,
      "label": "Products to show",
      "default": 8
    },
    {
      "type": "select",
      "id": "columns",
      "label": "Columns (desktop)",
      "options": [
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ],
      "default": "4"
    }
  ],
  "presets": [
    {
      "name": "Featured collection"
    }
  ]
}
{% endschema %}
